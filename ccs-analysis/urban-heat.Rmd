---
title: 'CCS Knowlede Map Results: Urban Heat'
author: "Corey Jackson"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---


```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(DT)
library(ggsci)
library(gridExtra)
library(stringr)
library(broom) # For tidy chi-squared test results
# Import all datasets
heat_survey <- read.csv("/Volumes/cbjackson2/ccs-knowledge/ccs-data/urban-heat/heat_survey.csv")
heat_map <- read.csv("/Volumes/cbjackson2/ccs-knowledge/ccs-data/urban-heat/heat_map.csv")

# Questions - https://docs.google.com/document/d/1hl5Eb66a8j7TDE1EzzOF4eUjUguet5dMsw7UJydr_uY/edit

# Cleaning functions
clean_matrix <- function(dataframe, column_name) {
  cleaned_data <- dataframe %>%
    separate_rows({{ column_name }}, sep = "; ") %>%
    separate({{ column_name }}, into = c("question", "answer"), sep = " - ")
  cleaned_data$answer <- as.factor(cleaned_data$answer)
  
  summary_data <- cleaned_data %>%
    group_by(question, answer) %>%
    summarise(n = n()) %>%
    mutate(freq = round((n / sum(n)),digits=2     )*100)
  
  return(summary_data)
}

clean_box <- function(data, response) {
  summary_data <- data %>%
    group_by({{ response }}) %>%
    summarise(count = n()) %>%
    mutate(freq = round(count / sum(count), digits = 2)*100)
    names(summary_data)[1] <- "response"

  return(summary_data)
}


clean_multi <- function(data, response) {
  cleaned_data <- data %>%
    separate_rows({{ response }}, sep = "; ")
  
  summary_data <- cleaned_data %>%
    group_by({{ response }}) %>%
    summarise(count = n()) %>%
    mutate(freq = round(count / sum(count), digits = 2) * 100)
      names(summary_data)[1] <- "response"

  return(summary_data)
}


# Viz functions
viz_matrix <- function(dataframe, graph_title) {
  ggplot(dataframe, aes(x=question, y=freq, fill=answer)) +
    geom_bar(stat="identity", position="stack") +
    theme_minimal() +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 40)) + # Wrap labels to a width of 5 words
    coord_flip() +
    labs(title=graph_title,
         x="Question",
         y="Frequency (%)",
         fill="Answer") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
scale_fill_nejm()
}

viz_box_multi <- function(dataframe,graph_title) {
  # Order the dataframe by decreasing frequency
  ordered_df <- dataframe %>%
    arrange(desc(freq))
  
  # Create the bar chart
  ggplot(ordered_df, aes(x=reorder(response, -freq), y=freq)) +
    geom_bar(stat="identity", fill="blue") +
    theme_minimal() +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 40)) + # Wrap labels to a width of 5 words
    coord_flip() +
    labs(title=graph_title,
         x="Response",
         y="Frequency (%)") +
    theme(axis.text.x = element_text(angle=45, hjust=1))+
scale_fill_nejm()
}
```

## Urban Heat (UH)
```{r uh-setup, include=FALSE, cache=TRUE}

# Report the analysis of survey items here
# Report the analysis of survey items here

names(heat_survey)[5:12] <- c("urban_heat_experience",
    "summer_activity_frequency",
    "disproportionate_heat_impact",
    "personal_heat_actions",
    "government_heat_mitigation",
    "heat_information_sources",
    "community_heat_participation",
    "heat_education_needs")


summer_activity_frequency <- clean_matrix(heat_survey, summer_activity_frequency)
summer_activity_frequency_viz <- viz_matrix(summer_activity_frequency, "Summer Activity Frequency")

personal_heat_actions <- clean_multi(heat_survey, personal_heat_actions)
personal_heat_actions_viz <- viz_box_multi(personal_heat_actions, "Personal Heat Actions")

heat_information_sources <- clean_multi(heat_survey, heat_information_sources)
heat_information_sources_viz <- viz_box_multi(heat_information_sources,"Heat Information Sources")

community_heat_participation <- clean_multi(heat_survey, community_heat_participation)
community_heat_participation_viz <- viz_box_multi(community_heat_participation, "Community Heat Participation")
```

- Description of survey and the questions asked

### UH Analysis
```{r uh-analysis-report, echo=TRUE}

```

### Please rate how frequently you have done each of the following during summer months and during extreme heat.
```{r}
datatable(summer_activity_frequency)
summer_activity_frequency_viz
```


### Which of the following personal steps have you taken to reduce your contribution to urban heat and reduce greenhouse emissions?
```{r}
datatable(personal_heat_actions)
personal_heat_actions_viz
```


### Where do you currently go for information about heat (waves)? And how do you usually learn about extremely hot weather?
```{r}
datatable(heat_information_sources)
heat_information_sources_viz
```


### Are you interested in participating in community-based efforts to address urban heat in your neighborhood?
```{r}
datatable(community_heat_participation)
community_heat_participation_viz
```

 
### UH Map
```{r uh-map-report, echo=TRUE}

# Report the analysis of survey items here

```


# Meta Summary

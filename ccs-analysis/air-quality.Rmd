---
title: 'CCS Knowledge Map Results: Air Quality'
author: "Corey Jackson"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(DT)
library(ggsci)

air_survey <- read.csv("/Volumes/cbjackson2/ccs-knowledge/ccs-data/air-quality/air_survey.csv")
air_map <- read.csv("/Volumes/cbjackson2/ccs-knowledge/ccs-data/air-quality/air_map.csv")

# Questions - https://docs.google.com/document/d/1hl5Eb66a8j7TDE1EzzOF4eUjUguet5dMsw7UJydr_uY/edit

# Cleaning functions
clean_matrix <- function(dataframe, column_name) {
  cleaned_data <- dataframe %>%
    separate_rows({{ column_name }}, sep = "; ") %>%
    separate({{ column_name }}, into = c("question", "answer"), sep = " - ")
  cleaned_data$answer <- as.factor(cleaned_data$answer)
  
  summary_data <- cleaned_data %>%
    group_by(question, answer) %>%
    summarise(n = n()) %>%
    mutate(freq = round((n / sum(n)),digits=2     )*100)
  
  return(summary_data)
}

viz_box_multi <- function(dataframe,graph_title) {
  # Order the dataframe by decreasing frequency
  ordered_df <- dataframe %>%
    arrange(desc(freq))
  
  # Create the bar chart
  ggplot(ordered_df, aes(x=reorder(response, -freq), y=freq)) +
    geom_bar(stat="identity", fill="blue") +
    theme_minimal() +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 40)) + # Wrap labels to a width of 5 words
    coord_flip() +
    labs(title=graph_title,
         x="Response",
         y="Frequency (%)") +
    theme(axis.text.x = element_text(angle=45, hjust=1))+
scale_fill_nejm()
}


clean_box <- function(data, response) {
  summary_data <- data %>%
    group_by({{ response }}) %>%
    summarise(count = n()) %>%
    mutate(freq = round(count / sum(count), digits = 2)*100)
  
  return(summary_data)
}


clean_multi <- function(data, response) {
  cleaned_data <- data %>%
    separate_rows({{ response }}, sep = "; ")
  
  summary_data <- cleaned_data %>%
    group_by({{ response }}) %>%
    summarise(count = n()) %>%
    mutate(freq = round(count / sum(count), digits = 2) * 100)
  
  return(summary_data)
}
```

```{r, include=FALSE}
names(air_survey)[5:14] <- c("Air_Quality_Experience",
               "Pollution_Health_Impact",
               "Pollution_Sources_Identification",
               "Quality_Change_Perception",
               "Vulnerable_Populations_Impact",
               "Contaminants_Awareness_Knowledge",
               "Sensor_Location_Suggestions",
               "Improvement_Actions_Taken",
               "Alert_Reception_Preference",
               "Deployment_Participation_Interest")

pollution <- clean_multi(air_survey,Pollution_Health_Impact)

```


```{r}
# Causing Error
# datatable(pollution)
# viz_box_multi(pollution,"Air QQQQQQ")

```

## Air Quality (AQ)

### Have you or anyone you know experienced the following health issues related to poor air quality?

```{r}
Pollution_Health_Impact <- clean_multi(air_survey,Pollution_Health_Impact)
datatable(Pollution_Health_Impact)
```

### What do you think are the sources of air pollution in your community?
```{r}
Pollution_Sources_Identification <- clean_multi(air_survey,Pollution_Sources_Identification)
datatable(Pollution_Sources_Identification)
```

### Have you noticed any changes in air quality in your community over the past 5 years?
```{r}
Quality_Change_Perception <- clean_box(air_survey,Quality_Change_Perception)
datatable(Quality_Change_Perception)
```

### Did you know Particulate matter (PM) and ground-level Ozone are common air contaminants harmful to human health?
```{r}
Contaminants_Awareness_Knowledge <- clean_multi(air_survey,Contaminants_Awareness_Knowledge)
datatable(Contaminants_Awareness_Knowledge)
```

### If you are providing suggestions for the city regarding where to install air quality monitoring sensors across Madison. Where would you like to see these sensors located?
```{r}
Sensor_Location_Suggestions <- clean_multi(air_survey,Sensor_Location_Suggestions)
datatable(Sensor_Location_Suggestions)
```

### If air quality becomes an issue and alerts need to be sent, how would you like to receive information about the air quality in your neighborhood?
```{r}
Alert_Reception_Preference <- clean_multi(air_survey,Alert_Reception_Preference)
datatable(Alert_Reception_Preference)
```

### If there will be opportunities for you to participate in deciding where to deploy the air quality monitoring sensors. How would you like to be part of it? What roles would you like to take?
```{r}
Deployment_Participation_Interest <- clean_box(air_survey,Deployment_Participation_Interest)
datatable(Deployment_Participation_Interest)
```


- Description of survey and the questions asked




### AQ Map
```{r aq-map-report, echo=TRUE}

# Report the analysis of map items here

```



# Meta Summary


